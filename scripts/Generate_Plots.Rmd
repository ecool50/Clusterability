---
title: "Generate Plots"
author: "Elijah Willie"
date: "04/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required librares
```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(Seurat)
  library(Seurat)
  library(fastcluster)
  library(parallelDist)
  library(tidyverse)
  library(cluster)
  library(Rclusterpp)
  library(sigclust2)
  library(data.table)
  library("diptest")
  library(Rtsne)
  library(PPCI)
  library(splatter)
  library(SC3)
  library(scater)
  library(SingleCellExperiment)
  library(jackstraw)
  library(parallelDist)
  library(irlba)
  library(WGCNA)
  library(Rfast)
  library(data.table)
  library(gridExtra)
  library(reticulate)
  library(corpcor)
  library(trqwe)
  library(cowplot)
  library(umap)
  library(pheatmap)
  library(ggplotify)
}
)
setwd("/home/elijah/Documents/Clusterability")
source("Helper_Functions.R")
source("/home/elijah/Documents/scrna2019/algs/glmpca.R")
source("/home/elijah/Documents/scrna2019/util/functions.R")
source("/home/elijah/Documents/scrna2019/util/functions_genefilter.R")
source("Pipeline_Functions.R")
use_virtualenv("r-reticulate")
use_python("/usr/local/bin/python3")
```

# Generate the first set of plots
```{r}
# set the splatter parameters 
splat.params <- newSplatParams(batchCells = 2000, nGenes = 2000, seed = 1994)

# generate a single group
sim.single <- splatSimulateGroups(splat.params, verbose = FALSE)

# generate multiple groups
sim.multiple <- splatSimulateGroups(splat.params, group.prob = c(1/3, 1/3, 1/3), verbose = FALSE)

# Generate multiple groups with minimal overlaps
sim.multiple.min <- splatSimulateGroups(splat.params, group.prob = c(1/3, 1/3, 1/3), de.facLoc = c(1,1,1)*0.5,
                               de.facScale = c(1,1,1)*0.5, verbose = FALSE)

# Generate multiple groups with maximal overlaps
sim.multiple.max <- splatSimulateGroups(splat.params, group.prob = c(1/3, 1/3, 1/3), de.facLoc = c(1,1,1)*0,
                               de.facScale = c(1,1,1)*0, verbose = FALSE)

# generate the plots
sim.single.norm <- scater::normalize(sim.single)
p.single <- plotPCA(sim.single.norm) + ggtitle("Single Group")
sim.multiple.min.norm <- scater::normalize(sim.multiple.min)
p.multiple.min <- plotPCA(sim.multiple.min.norm, colour_by = "Group") + ggtitle("Minimal Overlap")
sim.multiple.max.norm <- scater::normalize(sim.multiple.max)
p.multiple.max <- plotPCA(sim.multiple.max.norm, colour_by = "Group") + ggtitle("Maximal Overlap")
sim.multiple.norm <- scater::normalize(sim.multiple)
p.multiple <- plotPCA(sim.multiple.norm, colour_by = "Group") + ggtitle("Multiple Groups")

# Combine the plots
t.pca <-  plot_grid(p.single, p.multiple, p.multiple.min, p.multiple.max, labels=c("A", "B", "C", "D"))


```

## Generate the MDH plots
```{r}
# singe group
sim.single.obj <- CreateModalityObject(counts(sim.single))
sim.single.obj <- PreprocessObject(sim.single.obj, nFeatures = 1500)
sim.single.obj <- PreprocessObject(sim.single.obj, method = "Scrna", nFeatures = 1500)
sim.single.seurat.df <- as.data.frame(sim.single.obj@Seurat$MDH$fitted)
sim.single.scrna.df <- as.data.frame(sim.single.obj@Scrna$MDH$fitted)
p.single.seurat <- ggplot(sim.single.seurat.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Single Group MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)
p.single.scrna <- ggplot(sim.single.scrna.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Single Group MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)

# multiple group
sim.multiple.obj <- CreateModalityObject(counts(sim.multiple))
sim.multiple.obj <- PreprocessObject(sim.multiple.obj, nFeatures = 500)
sim.multiple.obj <- PreprocessObject(sim.multiple.obj, method = "Scrna", nFeatures = 500)
# Modality tests
sim.multiple.obj <- TestModality(sim.multiple.obj)
sim.multiple.obj <- TestModality(sim.multiple.obj, type = "Scrna")

# compute a result table for all the tests
seurat <- as.data.frame(unlist(sim.multiple.obj@Tests$Seurat))
colnames(seurat) <- c("Seurat.Dip.Pvalue")

scrna <- as.data.frame(unlist(sim.multiple.obj@Tests$Scrna))
colnames(scrna) <- c("Scrna.Dip.Pvalue")

res_table <- cbind(scrna, seurat)
colnames(res_table) <- c("Seurat", "Scrna")

# plot heat map
sim.multiple.heat.map <- as.ggplot(pheatmap(as.matrix(res_table), cluster_rows = F, cluster_cols = F, breaks = c(0, 0.05, 1), color = c("lightblue", "gray"), main = "Heatmap"))

sim.multiple.seurat.df <- as.data.frame(sim.multiple.obj@Seurat$MDH$fitted)
sim.multiple.scrna.df <- as.data.frame(sim.multiple.obj@Scrna$MDH$fitted)
p.multiple.seurat <- ggplot(sim.multiple.seurat.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Multiple Groups MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)
p.multiple.scrna <- ggplot(sim.multiple.scrna.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Multiple Groups MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)

# Multiple groups minimal overlaps
sim.multiple.min.obj <- CreateModalityObject(counts(sim.multiple.min))
sim.multiple.min.obj <- PreprocessObject(sim.multiple.min.obj, nFeatures = 1500)
sim.multiple.min.obj <- PreprocessObject(sim.multiple.min.obj, method = "Scrna", nFeatures = 1500)
sim.multiple.min.seurat.df <- as.data.frame(sim.multiple.min.obj@Seurat$MDH$fitted)
sim.multiple.min.scrna.df <- as.data.frame(sim.multiple.min.obj@Scrna$MDH$fitted)
p.multiple.min.seurat <- ggplot(sim.multiple.min.seurat.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Minimal Overlap MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)
p.multiple.min.scrna <- ggplot(sim.multiple.min.scrna.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Minimal Overlap MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)


# Multiple groups maximal overlaps
sim.multiple.max.obj <- CreateModalityObject(counts(sim.multiple.max))
sim.multiple.max.obj <- PreprocessObject(sim.multiple.max.obj, nFeatures = 500)
sim.multiple.max.obj <- PreprocessObject(sim.multiple.max.obj, method = "Scrna", nFeatures = 1500)
sim.multiple.max.seurat.df <- as.data.frame(sim.multiple.max.obj@Seurat$MDH$fitted)
sim.multiple.max.scrna.df <- as.data.frame(sim.multiple.max.obj@Scrna$MDH$fitted)
p.multiple.max.seurat <- ggplot(sim.multiple.max.seurat.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Maximal Overlap MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)
p.multiple.max.scrna <- ggplot(sim.multiple.max.scrna.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Maximal Overlap MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1)


# compute the plots
t.seurat <- plot_grid(p.single.seurat, p.multiple.seurat, p.multiple.min.seurat, p.multiple.max.seurat, labels=c("A", "B", "C", "D"))
t.scrna <- plot_grid(p.single.scrna, p.multiple.scrna, p.multiple.min.scrna, p.multiple.max.scrna, labels=c("A", "B", "C", "D"))
```


## Generate PCA plots
```{r}
sim.multiple.seurat.df <- as.data.frame(sim.multiple.obj@Seurat$Sig.PCs.Data[, 1:2])
sim.multiple.scrna.df <- as.data.frame(sim.multiple.obj@Scrna$Sig.PCs.Data[, 1:2])

# Run PCA
p.sim.multiple.seurat.pca <- ggplot(sim.multiple.seurat.df) + geom_point(aes(PC_1, PC_2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("Seurat PCA") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))
p.sim.multiple.scrna.pca <- ggplot(sim.multiple.scrna.df) + geom_point(aes(PC1, PC2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("Scrna PCA") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))
```


## Generate the Tsne plot
```{r}
# single group
sim.single.tsne.seurat <- as.data.frame(Rtsne(sim.single.obj@Seurat$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
sim.single.tsne.scrna <- as.data.frame(Rtsne(sim.single.obj@Scrna$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
sim.single.tsne.plot <- ggplot(sim.single.tsne.seurat) + geom_point(aes(V1, V2)) + labs(title = "Single Group", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
sim.single.tsne.scrna <- as.data.frame(Rtsne(sim.single.obj@Scrna$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)

# multiple groups
sim.multiple.seurat.tsne <- as.data.frame(sim.multiple.obj@Seurat$Tsne.Data)
p.multiple.seurat.tsne <-  ggplot(sim.multiple.seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = "Seurat Tsne", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

sim.multiple.scrna.tsne <- as.data.frame(sim.multiple.obj@Scrna$Tsne.Data)
p.multiple.scrna.tsne <-  ggplot(sim.multiple.scrna.tsne) + geom_point(aes(V1, V2)) + labs(title = "Scrna Tsne", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# Maximal overlaps
sim.multiple.max.tsne.seurat <- as.data.frame(Rtsne(sim.multiple.max.obj@Seurat$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
sim.multiple.max.tsne.scrna <- as.data.frame(Rtsne(sim.multiple.max.obj@Scrna$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
sim.multiple.max.tsne.plot <- ggplot(sim.multiple.max.tsne.seurat) + geom_point(aes(V1, V2)) + labs(title = "Maximal Overlap", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# Minimal overlap
sim.multiple.min.tsne.seurat <- as.data.frame(Rtsne(sim.multiple.min.obj@Seurat$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
sim.multiple.min.tsne.scrna <- as.data.frame(Rtsne(sim.multiple.min.obj@Scrna$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
sim.multiple.min.tsne.plot <- ggplot(sim.multiple.min.tsne.seurat) + geom_point(aes(V1, V2)) + labs(title = "Minimal Overlap", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# combine the plots
t.tsne <- plot_grid(sim.single.tsne.plot, sim.multiple.tsne.plot, sim.multiple.min.tsne.plot, sim.multiple.max.tsne.plot, labels=c("A", "B", "C", "D"))
```

## Generate UMAP plots
```{r}
# single group
sim.single.umap.seurat <- as.data.frame(umap(sim.single.obj@Seurat$Sig.PCs.Data, method = "umap-learn")$layout)
sim.single.umap.scrna <- as.data.frame(umap(sim.single.obj@Scrna$Sig.PCs.Data, method = "umap-learn")$layout)
sim.single.umap.plot <- ggplot(sim.single.umap.seurat) + geom_point(aes(V1, V2)) + labs(title = "Single Group", x = "UMAP_1", y = "UMAP_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
sim.single.umap.scrna <- as.data.frame(umap(sim.single.obj@Scrna$Sig.PCs.Data, method = "umap-learn")$layout)

# multiple groups
sim.multiple.seurat.umap <- as.data.frame(sim.multiple.obj@Seurat$Umap.Data)
p.multiple.seurat.umap <-  ggplot(sim.multiple.seurat.umap) + geom_point(aes(V1, V2)) + labs(title = "Seurat Umap", x = "umap_1", y = "umap_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

sim.multiple.scrna.umap <- as.data.frame(sim.multiple.obj@Scrna$Umap.Data)
p.multiple.scrna.umap <-  ggplot(sim.multiple.scrna.umap) + geom_point(aes(V1, V2)) + labs(title = "Scrna Umap", x = "umap_1", y = "umap_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# Maximal overlaps
sim.multiple.max.umap.seurat <- as.data.frame(umap(sim.multiple.max.obj@Seurat$Sig.PCs.Data, method = "umap-learn")$layout)
sim.multiple.max.umap.scrna <- as.data.frame(umap(sim.multiple.max.obj@Scrna$Sig.PCs.Data, method = "umap-learn")$layout)
sim.multiple.max.umap.plot <- ggplot(sim.multiple.max.umap.seurat) + geom_point(aes(V1, V2)) + labs(title = "Maximal Overlap", x = "UMAP_1", y = "UMAP_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# Minimal overlap
sim.multiple.min.umap.seurat <- as.data.frame(umap(sim.multiple.min.obj@Seurat$Sig.PCs.Data, method = "umap-learn")$layout)
sim.multiple.min.umap.scrna <- as.data.frame(umap(sim.multiple.min.obj@Scrna$Sig.PCs.Data, method = "umap-learn")$layout)
sim.multiple.min.umap.plot <- ggplot(sim.multiple.min.umap.seurat) + geom_point(aes(V1, V2)) + labs(title = "Minimal Overlap", x = "UMAP_1", y = "UMAP_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# combine the plots
t.umap <- plot_grid(sim.single.umap.plot, sim.multiple.umap.plot, sim.multiple.min.umap.plot, sim.multiple.max.umap.plot, labels=c("A", "B", "C", "D"))

```


## Generate the density plots
```{r}
# single group
## seurat
sim.single.seurat.mdh <- as.vector(parallelDist(sim.single.obj@Seurat$MDH$fitted))
sim.single.seurat.pca <- as.vector(as.dist(1 - cor1(t(sim.single.obj@Seurat$Sig.PCs.Data), verbose = T)))
sim.single.seurat.raw <- as.vector(as.dist(1 - cor1(sim.single.obj@Seurat$Scaled.Data)))
# sim.single.densities.df <- data.frame(sim.single.seurat.mdh,sim.single.seurat.pca, sim.single.seurat.raw)
# colnames(sim.single.densities.df) <- c("MDH", "PCA", "Raw")
# 
# sim.single.densities.stack <- stack(sim.single.densities.df)
# colnames(sim.single.densities.stack) <- c("values", "Method")
# p.single.densities <- ggplot(sim.single.densities.stack, aes(x = values)) +
#   stat_density(aes(group = Method, color = Method),position="identity",geom="line") + 
#   ggtitle("Single Group Densities")

# Multiple group
sim.multiple.seurat.mdh <- as.vector(parallelDist(sim.multiple.obj@Seurat$MDH$fitted))
sim.multiple.seurat.pca <- as.vector(as.dist(1 - cor1(t(sim.multiple.obj@Seurat$Sig.PCs.Data), verbose = T)))
sim.multiple.seurat.raw <- as.vector(as.dist(1 - cor1(sim.multiple.obj@Seurat$Scaled.Data)))
# sim.multiple.densities.df <- data.frame(sim.multiple.seurat.mdh,sim.multiple.seurat.pca, sim.multiple.seurat.raw)
# colnames(sim.multiple.densities.df) <- c("MDH", "PCA", "Raw")
# 
# sim.multiple.densities.stack <- stack(sim.multiple.densities.df)
# colnames(sim.multiple.densities.stack) <- c("values", "Method")
# p.multiple.densities <- ggplot(sim.multiple.densities.stack, aes(x = values)) +
#   stat_density(aes(group = Method, color = Method),position="identity",geom="line") + 
#   ggtitle("Multiple Groups Densities")


# multiple groups minimal overlap
sim.multiple.min.seurat.mdh <- as.vector(parallelDist(sim.multiple.min.obj@Seurat$MDH$fitted))
sim.multiple.min.seurat.pca <- as.vector(as.dist(1 - cor1(t(sim.multiple.min.obj@Seurat$Sig.PCs.Data), verbose = T)))
sim.multiple.min.seurat.raw <- as.vector(as.dist(1 - cor1(sim.multiple.min.obj@Seurat$Scaled.Data)))
# sim.multiple.min.densities.df <- data.frame(sim.multiple.min.seurat.mdh,sim.multiple.min.seurat.pca, sim.multiple.min.seurat.raw)
# colnames(sim.multiple.min.densities.df) <- c("MDH", "PCA", "Raw")
# 
# sim.multiple.min.densities.stack <- stack(sim.multiple.min.densities.df)
# colnames(sim.multiple.min.densities.stack) <- c("values", "Method")
# p.multiple.min.densities <- ggplot(sim.multiple.min.densities.stack, aes(x = values)) +
#   stat_density(aes(group = Method, color = Method),position="identity",geom="line") + 
#   ggtitle("Minimal Overlap Densities")

# multiple groups maximal overlaps
sim.multiple.max.seurat.mdh <- as.vector(parallelDist(sim.multiple.max.obj@Seurat$MDH$fitted))
sim.multiple.max.seurat.pca <- as.vector(as.dist(1 - cor1(t(sim.multiple.max.obj@Seurat$Sig.PCs.Data), verbose = T)))
sim.multiple.max.seurat.raw <- as.vector(as.dist(1 - cor1(sim.multiple.max.obj@Seurat$Scaled.Data)))
# sim.multiple.max.densities.df <- data.frame(sim.multiple.max.seurat.mdh,sim.multiple.max.seurat.pca, sim.multiple.max.seurat.raw)
# colnames(sim.multiple.max.densities.df) <- c("MDH", "PCA", "Raw")
# 
# sim.multiple.max.densities.stack <- stack(sim.multiple.max.densities.df)
# colnames(sim.multiple.max.densities.stack) <- c("values", "Method")
# p.multiple.max.densities <- ggplot(sim.multiple.max.densities.stack, aes(x = values)) +
#   stat_density(aes(group = Method, color = Method),position="identity",geom="line") + 
#   ggtitle("Maximal Overlap Densities")

# MDH plots
mdh <- data.frame(sim.single.seurat.mdh, sim.multiple.seurat.mdh, sim.multiple.min.seurat.mdh, sim.multiple.max.seurat.mdh)
colnames(mdh) <- c("Single Group", "Multiple Groups", "Minimal Overlap", "Maximal Overlap")
mdh.stack <- stack(mdh)
colnames(mdh.stack) <- c("values", "Data")
p.mdh <- ggplot(mdh.stack, aes(x = values)) +
  stat_density(aes(group = Data, color = Data),position="identity",geom="line") + 
          ggtitle("MDH Densities")



# PCA plots
pca <- data.frame(sim.single.seurat.pca, sim.multiple.seurat.pca, sim.multiple.min.seurat.pca, sim.multiple.max.seurat.pca)
colnames(pca) <- c("Single Group", "Multiple Groups", "Minimal Overlap", "Maximal Overlap")
pca.stack <- stack(pca)
colnames(pca.stack) <- c("values", "Data")
p.pca <- ggplot(pca.stack, aes(x = values)) +
  stat_density(aes(group = Data, color = Data),position="identity",geom="line") + 
          ggtitle("PCA Densities")

# Raw plots
raw <- data.frame(sim.single.seurat.raw, sim.multiple.seurat.raw, sim.multiple.min.seurat.raw, sim.multiple.max.seurat.raw)
colnames(raw) <- c("Single Group", "Multiple Groups", "Minimal Overlap", "Maximal Overlap")
raw.stack <- stack(raw)
colnames(raw.stack) <- c("values", "Data")
p.raw <- ggplot(raw.stack, aes(x = values)) +
  stat_density(aes(group = Data, color = Data),position="identity",geom="line") + 
          ggtitle("Raw Densities")


# combine the plots
t.density <- plot_grid(p.mdh, p.pca, p.raw, labels = c("A", "B", "C"))
```


## Save the plots
```{r}
pdf("Results/Pipeline/Paper_Plots/Simulation_Positive_Control_Plots.pdf", width = 10, height = 10)
t <- plot_grid(p.sim.multiple.seurat.pca, p.sim.multiple.scrna.pca, p.multiple.seurat.tsne, p.multiple.scrna.tsne,
               p.multiple.seurat.umap, p.multiple.scrna.umap, sim.multiple.heat.map, labels = c("A", "B","C", "D", "E", "F","G"))
plot(t)
# plot(t.pca)
# plot(t.tsne)
# plot(t.umap)
# plot(t.scrna)
# plot(t.seurat)
# plot(t.density)
dev.off()
```



# Real Data

## Citro
```{r}
counts <- fread("Data/Citro_hash_noCycle_noMyeloid.txt") %>% column_to_rownames(var = "V1")
# run the pipeline
citro.obj <- CreateModalityObject(counts)

# add the seurat slot
citro.obj <- PreprocessObject(citro.obj,  nFeatures = 500)

# add the scrna slot
citro.obj <- PreprocessObject(citro.obj, method = "Scrna", nFeatures = 500)

# Modality tests
citro.obj <- TestModality(citro.obj)
citro.obj <- TestModality(citro.obj, type = "Scrna")

# compute a result table for all the tests
seurat <- as.data.frame(unlist(citro.obj@Tests$Seurat))
colnames(seurat) <- c("Seurat.Dip.Pvalue")

scrna <- as.data.frame(unlist(citro.obj@Tests$Scrna))
colnames(scrna) <- c("Scrna.Dip.Pvalue")

res_table <- cbind(scrna, seurat)
colnames(res_table) <- c("Seurat", "Scrna")

# plot heatmap
citro.heatmap <- as.ggplot(pheatmap(as.matrix(res_table), cluster_rows = F, cluster_cols = F, breaks = c(0, 0.05, 1), color = c("lightblue", "gray"), main = "Heatmap"))

# compute the proportions of passed test
citro.obj <- ComputeProportions(citro.obj)

# plot the results
t1 <- as.data.frame(unlist(citro.obj@Tests$Seurat$Proportions))
colnames(t1) <- c("Proportion")
t2 <- as.data.frame(unlist(citro.obj@Tests$Scrna$Proportions))
colnames(t2) <- c("Proportion")
t3 <- rbind(t1, t2)
t3$Type <- as.factor(rownames(t3))
seurat_pca_df <- as.data.frame(citro.obj@Seurat$Sig.PCs.Data[, 1:2])
scrna_pca_df <- as.data.frame(citro.obj@Scrna$Sig.PCs.Data[, 1:2])

# Run PCA
p.citro.pca <- ggplot(seurat_pca_df) + geom_point(aes(PC_1, PC_2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("Seurat PCA") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))
p.citro.pca.scrna <- ggplot(scrna_pca_df) + geom_point(aes(PC1, PC2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("Scrna PCA") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))

# Plot the Tsne
citro.seurat.tsne <- as.data.frame(citro.obj@Seurat$Tsne.Data)
p.citro.seurat.tsne <-  ggplot(citro.seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = "Seurat Tsne", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

citro.scrna.tsne <- as.data.frame(citro.obj@Scrna$Tsne.Data)
p.citro.scrna.tsne <-  ggplot(citro.scrna.tsne) + geom_point(aes(V1, V2)) + labs(title = "Scrna Tsne", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# plot UMAP
citro.seurat.umap <- as.data.frame(citro.obj@Seurat$Umap.Data)
p.citro.seurat.umap <- ggplot(citro.seurat.umap) + geom_point(aes(V1, V2)) + labs(title = "Seurat UMAP", x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

citro.scrna.umap <- as.data.frame(citro.obj@Scrna$Umap.Data)
p.citro.scrna.umap <- ggplot(citro.scrna.umap) + geom_point(aes(V1, V2)) + labs(title = "Scrna UMAP", x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

citro.plots <- plot_grid(p.citro.pca, p.citro.pca.scrna, p.citro.seurat.tsne, p.citro.scrna.tsne, 
                       p.citro.seurat.umap, p.citro.scrna.umap, citro.heatmap, labels = c("A", "B","C", "D", "E", "F","G"))


```

## save the plots
```{r}
pdf("Results/Pipeline/Paper_Plots/Citro_Plots.pdf", width = 10, height = 10)
plot(citro.plots)
dev.off()
```


## SPF NO CC NO NKT
```{r}
# get the counts data
counts <- fread("Data/spf_noCC_noNKT.txt") %>% column_to_rownames(var = "V1")
# run the pipeline
spf.noCC.obj <- CreateModalityObject(counts)

# add the seurat slot
spf.noCC.obj <- PreprocessObject(spf.noCC.obj,  nFeatures = 500)

# add the scrna slot
spf.noCC.obj <- PreprocessObject(spf.noCC.obj, method = "Scrna", nFeatures = 500)


# Modality tests
spf.noCC.obj <- TestModality(spf.noCC.obj)
spf.noCC.obj <- TestModality(spf.noCC.obj, type = "Scrna")

# compute a result table for all the tests
seurat <- as.data.frame(unlist(spf.noCC.obj@Tests$Seurat))
colnames(seurat) <- c("Seurat.Dip.Pvalue")

scrna <- as.data.frame(unlist(spf.noCC.obj@Tests$Scrna))
colnames(scrna) <- c("Scrna.Dip.Pvalue")

res_table <- cbind(scrna, seurat)
colnames(res_table) <- c("Seurat", "Scrna")



# compute the proportions of passed test
spf.noCC.obj <- ComputeProportions(spf.noCC.obj)



# plot the results
t1 <- as.data.frame(unlist(spf.noCC.obj@Tests$Seurat$Proportions))
colnames(t1) <- c("Proportion")
t2 <- as.data.frame(unlist(spf.noCC.obj@Tests$Scrna$Proportions))
colnames(t2) <- c("Proportion")
t3 <- rbind(t1, t2)
t3$Type <- as.factor(rownames(t3))
seurat_pca_df <- as.data.frame(spf.noCC.obj@Seurat$Sig.PCs.Data[, 1:2])
p.spf.noCC.pca <- ggplot(seurat_pca_df) + geom_point(aes(PC_1, PC_2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("PCA plot") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))
p.spf.noCC.sig.prop <- ggplot(t3) + geom_point(aes(Type, Proportion))  +
                                        xlab("Method") + ylab("Proportion") +  ggtitle("Significance Proportions") + theme_grey()+
                            theme(axis.text.x = element_text(angle = 90), plot.title = element_text(hjust = 0.5))

spf.noCC.seurat.df <- as.data.frame(spf.noCC.obj@Seurat$MDH$fitted)
spf.noCC.scrna.df <- as.data.frame(spf.noCC.obj@Scrna$MDH$fitted)
p.spf.noCC.seurat <- ggplot(spf.noCC.seurat.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Seurat MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1) + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))
p.spf.noCC.scrna <- ggplot(spf.noCC.scrna.df) + geom_point(aes(v, V2), alpha = 0.5)  +
                                        xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Scrna MDH") +
                                              geom_density_2d(aes(v, V2), colour = "red", size = 1) + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))


p.spf.noCC.seurat.tsne <- as.data.frame(Rtsne(spf.noCC.obj@Seurat$Sig.PCs.Data, perplexity=30, verbose=TRUE, max_iter = 500, pca = F, normalize = F)$Y)
p.spf.noCC.seurat.tsne.plot <-  ggplot(p.spf.noCC.seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = "Tsne Plot", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

spf.noCC.plots <- plot_grid(p.spf.noCC.pca, p.spf.noCC.seurat.tsne.plot, p.spf.noCC.seurat, p.spf.noCC.scrna, p.spf.noCC.sig.prop, labels = c("A", "B","C", "D", "E"))
```

## SPF ALL T-CELLS
```{r}
# get the counts data
counts <- fread("Data/SPF_allTcells.txt") %>% column_to_rownames(var = "V1")
# run the pipeline
spf.obj <- CreateModalityObject(counts)

# add the seurat slot
spf.obj <- PreprocessObject(spf.obj,  nFeatures = 500)

# add the scrna slot
spf.obj <- PreprocessObject(spf.obj, method = "Scrna", nFeatures = 500)

# Modality tests
spf.obj <- TestModality(spf.obj)
spf.obj <- TestModality(spf.obj, type = "Scrna")

# compute a result table for all the tests
seurat <- as.data.frame(unlist(spf.obj@Tests$Seurat))
colnames(seurat) <- c("Seurat.Dip.Pvalue")

scrna <- as.data.frame(unlist(spf.obj@Tests$Scrna))
colnames(scrna) <- c("Scrna.Dip.Pvalue")

res_table <- cbind(scrna, seurat)
colnames(res_table) <- c("Seurat", "Scrna")

# plot heat map
spf.heatmap <- pheatmap(as.matrix(res_table), cluster_rows = F, cluster_cols = F, breaks = c(0, 0.05, 1), color = c("lightblue", "gray"), main = "Heatmap")
spf.heatmap <- as.ggplot(spf.heatmap)


# compute the proportions of passed test
spf.obj <- ComputeProportions(spf.obj)

# plot the results
t1 <- as.data.frame(unlist(spf.obj@Tests$Seurat$Proportions))
colnames(t1) <- c("Proportion")
t2 <- as.data.frame(unlist(spf.obj@Tests$Scrna$Proportions))
colnames(t2) <- c("Proportion")
t3 <- rbind(t1, t2)
t3$Type <- as.factor(rownames(t3))
seurat_pca_df <- as.data.frame(spf.obj@Seurat$Sig.PCs.Data[, 1:2])
scrna_pca_df <- as.data.frame(spf.obj@Scrna$Sig.PCs.Data[, 1:2])

# Run PCA
p.spf.pca <- ggplot(seurat_pca_df) + geom_point(aes(PC_1, PC_2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("Seurat PCA") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))
p.spf.pca.scrna <- ggplot(scrna_pca_df) + geom_point(aes(PC1, PC2))  +
                                        xlab("PC1") + ylab("PC2") +  ggtitle("Scrna PCA") + theme_grey() +
                                          theme(plot.title = element_text(hjust = 0.5))

# Plot the Tsne
spf.seurat.tsne <- as.data.frame(spf.obj@Seurat$Tsne.Data)
p.spf.seurat.tsne <-  ggplot(spf.seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = "Seurat Tsne", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

spf.scrna.tsne <- as.data.frame(spf.obj@Scrna$Tsne.Data)
p.spf.scrna.tsne <-  ggplot(spf.scrna.tsne) + geom_point(aes(V1, V2)) + labs(title = "Scrna Tsne", x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# plot UMAP
spf.seurat.umap <- as.data.frame(spf.obj@Seurat$Umap.Data)
p.spf.seurat.umap <- ggplot(spf.seurat.umap) + geom_point(aes(V1, V2)) + labs(title = "Seurat UMAP", x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

spf.scrna.umap <- as.data.frame(spf.obj@Scrna$Umap.Data)
p.spf.scrna.umap <- ggplot(spf.scrna.umap) + geom_point(aes(V1, V2)) + labs(title = "Scrna UMAP", x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

# plot Phate
spf.seurat.phate <- as.data.frame(spf.obj@Seurat$Phate.Data)
p.spf.seurat.phate <-  ggplot(spf.seurat.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = "Seurat Phate", x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

spf.scrna.phate <- as.data.frame(spf.obj@Scrna$Phate.Data)
p.spf.scrna.phate <-  ggplot(spf.scrna.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = "Scrna Phate", x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))


# # Plot the significance proportions
# p.spf.sig.prop <- ggplot(t3) + geom_point(aes(Type, Proportion))  +
#                                         xlab("Method") + ylab("Proportion") +  ggtitle("Significance Proportions") + theme_grey()+
#                             theme(axis.text.x = element_text(angle = 90), plot.title = element_text(hjust = 0.5))

# # plot the projection densities
# spf.seurat.df <- as.data.frame(spf.obj@Seurat$MDH$fitted)
# spf.scrna.df <- as.data.frame(spf.obj@Scrna$MDH$fitted)
# p.spf.seurat <- ggplot(spf.seurat.df) + geom_point(aes(v, V2), alpha = 0.5)  +
#                                         xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Seurat MDH") +
#                                               geom_density_2d(aes(v, V2), colour = "red", size = 1) + theme_grey() +
#                                           theme(plot.title = element_text(hjust = 0.5))
# p.spf.scrna <- ggplot(spf.scrna.df) + geom_point(aes(v, V2), alpha = 0.5)  +
#                                         xlab("Plane 1") + ylab("Plane 2") +  ggtitle("Scrna MDH") +
#                                               geom_density_2d(aes(v, V2), colour = "red", size = 1) + theme_grey() +
#                                           theme(plot.title = element_text(hjust = 0.5))


spf.plots <- plot_grid(p.spf.pca, p.spf.pca.scrna, p.spf.seurat.tsne, p.spf.scrna.tsne, 
                       p.spf.seurat.umap, p.spf.scrna.umap, p.spf.seurat.phate, p.spf.scrna.phate, spf.heatmap, labels = c("A", "B","C", "D", "E", "F","G", "H", "I"))
```

## Generate the plots
```{r}
pdf("Results/Pipeline/Paper_Plots/SPF_All_T_Cells_Plots_Phate.pdf", width = 10, height = 10)
plot(spf.plots)
dev.off()
```

# Simulations

## Increasing Dimensions
```{r}
genes_dim <- seq(2000, 12000, 1000)
plot_lists <- list()

for(i in genes_dim){
  
  cat(paste("\nRunning on",i,"Genes\n"))
  
  params.groups <- newSplatParams(batchCells = 2000, nGenes = i, seed = 1994)
  
  # run simulations
  sim <- splatSimulateGroups(params.groups, verbose = FALSE)
  
  # extract the counts
  sim_counts <- counts(sim)
  
  # run the pipeline
  obj <- CreateModalityObject(sim_counts)
  
  # add the seurat slot
  obj <- PreprocessObject(obj,  nFeatures = 500)
  
  # add the scrna slot
  obj <- PreprocessObject(obj, method = "Scrna", nFeatures = 500)
  
  # Run the Seurat modality tests
  obj <- TestModality(obj)
  obj <- TestModality(obj, type = "Scrna")

  # compute a result table for all the tests
  seurat <- as.data.frame(unlist(obj@Tests$Seurat))
  colnames(seurat) <- c("Seurat.Dip.Pvalue")
  
  scrna <- as.data.frame(unlist(obj@Tests$Scrna))
  colnames(scrna) <- c("Scrna.Dip.Pvalue")
  
  res.table <- cbind(scrna, seurat)
  colnames(res.table) <- c("Seurat", "Scrna")
  
  # plot heat map
  obj.heatmap <- pheatmap(as.matrix(res.table), cluster_rows = F, cluster_cols = F, breaks = c(0, 0.05, 1), color = c("lightblue", "gray"), main = paste("Heatmap"))
  heatmap <- as.ggplot(obj.heatmap)
  
  seurat_pca_df <- as.data.frame(obj@Seurat$Sig.PCs.Data[, 1:2])
  scrna_pca_df <- as.data.frame(obj@Scrna$Sig.PCs.Data[, 1:2])
  
  # Run PCA
  p.pca <- ggplot(seurat_pca_df) + geom_point(aes(PC_1, PC_2))  +
                                          xlab("PC1") + ylab("PC2") +  ggtitle(paste("Seurat PCA on", i, "Genes")) + theme_grey() +
                                            theme(plot.title = element_text(hjust = 0.5))
  p.pca.scrna <- ggplot(scrna_pca_df) + geom_point(aes(PC1, PC2))  +
                                          xlab("PC1") + ylab("PC2") +  ggtitle(paste("Scrna PCA on", i, "Genes")) + theme_grey() +
                                            theme(plot.title = element_text(hjust = 0.5))
  
  # Plot the Tsne
  seurat.tsne <- as.data.frame(obj@Seurat$Tsne.Data)
  p.seurat.tsne <-  ggplot(seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = paste("Seurat Tsne on", i, "Genes"), x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  scrna.tsne <- as.data.frame(obj@Scrna$Tsne.Data)
  p.scrna.tsne <-  ggplot(scrna.tsne) + geom_point(aes(V1, V2)) + labs(title = paste("Scrna Tsne on", i, "Genes"), x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # plot UMAP
  seurat.umap <- as.data.frame(obj@Seurat$Umap.Data)
  p.seurat.umap <- ggplot(seurat.umap) + geom_point(aes(V1, V2)) + labs(title = paste("Seurat Umap on", i, "Genes"), x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  scrna.umap <- as.data.frame(obj@Scrna$Umap.Data)
  p.scrna.umap <- ggplot(scrna.umap) + geom_point(aes(V1, V2)) + labs(title = paste("Scrna Umap on", i, "Genes"), x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # plot Phate
  seurat.phate <- as.data.frame(obj@Seurat$Phate.Data)
p.seurat.phate <-  ggplot(seurat.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = "Seurat Phate", x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

  scrna.phate <- as.data.frame(obj@Scrna$Phate.Data)
p.scrna.phate <-  ggplot(scrna.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = "Scrna Phate", x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # combine the plots
  plots <- plot_grid(p.pca, p.pca.scrna, p.seurat.tsne, p.scrna.tsne, 
                         p.seurat.umap, p.scrna.umap, p.seurat.phate, p.scrna.phate, 
                     heatmap, labels = c("A", "B","C", "D", "E", "F","G", "H", "I"))
    

  
  plot_lists[[i]] <- plots
  gc()
  
  
}
```

## Save the plots
```{r}
pdf("Results/Pipeline/Paper_Plots/Genes_Simulations_Plots_Phate.pdf", width = 10, height = 10)
for(i in genes_dim){
  plot(plot_lists[[i]])
}
dev.off()
```

## Increasing Overlap
```{r}
overlaps <- seq(5, 50, 5)
plot_lists <- list()


# simulation parameters
prob_vec <- c(1/3, 1/3, 1/3)

for(i in overlaps){
  
  cat(paste("\nRunning on",i/100,"Overlap\n"))
  
  params.groups <- newSplatParams(batchCells = 2000, nGenes = 2000, seed = 1994)
  
  # run simulations
  sim <- splatSimulateGroups(params.groups, group.prob = prob_vec, de.facLoc = c(1,1,1)*i/100,
                               de.facScale = c(1,1,1)*i/100, verbose = FALSE)
  
  # extract the counts
  sim_counts <- counts(sim)
  
  # run the pipeline
  obj <- CreateModalityObject(sim_counts)
  
  # add the seurat slot
  obj <- PreprocessObject(obj,  nFeatures = 500)
  
  # add the scrna slot
  obj <- PreprocessObject(obj, method = "Scrna", nFeatures = 500)
  
  # Run the Seurat modality tests
  obj <- TestModality(obj)
  obj <- TestModality(obj, type = "Scrna")

  # compute a result table for all the tests
  seurat <- as.data.frame(unlist(obj@Tests$Seurat))
  colnames(seurat) <- c("Seurat.Dip.Pvalue")
  
  scrna <- as.data.frame(unlist(obj@Tests$Scrna))
  colnames(scrna) <- c("Scrna.Dip.Pvalue")
  
  res.table <- cbind(scrna, seurat)
  colnames(res.table) <- c("Seurat", "Scrna")
  
  # plot heat map
  obj.heatmap <- pheatmap(as.matrix(res.table), cluster_rows = F, cluster_cols = F, breaks = c(0, 0.05, 1), color = c("lightblue", "gray"), main = paste("Heatmap"))
  heatmap <- as.ggplot(obj.heatmap)
  
  seurat_pca_df <- as.data.frame(obj@Seurat$Sig.PCs.Data[, 1:2])
  scrna_pca_df <- as.data.frame(obj@Scrna$Sig.PCs.Data[, 1:2])
  
  # Run PCA
  p.pca <- ggplot(seurat_pca_df) + geom_point(aes(PC_1, PC_2))  +
                                          xlab("PC1") + ylab("PC2") +  ggtitle(paste("Seurat PCA on", i/100, "Overlap")) + theme_grey() +
                                            theme(plot.title = element_text(hjust = 0.5))
  p.pca.scrna <- ggplot(scrna_pca_df) + geom_point(aes(PC1, PC2))  +
                                          xlab("PC1") + ylab("PC2") +  ggtitle(paste("Scrna PCA on", i/100, "Overlap")) + theme_grey() +
                                            theme(plot.title = element_text(hjust = 0.5))
  
  # Plot the Tsne
  seurat.tsne <- as.data.frame(obj@Seurat$Tsne.Data)
  p.seurat.tsne <-  ggplot(seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = paste("Seurat Tsne on", i/100, "Overlap"), x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  scrna.tsne <- as.data.frame(obj@Scrna$Tsne.Data)
  p.scrna.tsne <-  ggplot(scrna.tsne) + geom_point(aes(V1, V2)) + labs(title = paste("Scrna Tsne on", i/100, "Overlap"), x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # plot UMAP
  seurat.umap <- as.data.frame(obj@Seurat$Umap.Data)
  p.seurat.umap <- ggplot(seurat.umap) + geom_point(aes(V1, V2)) + labs(title = paste("Seurat Umap on", i/100, "Overlap"), x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  scrna.umap <- as.data.frame(obj@Scrna$Umap.Data)
  p.scrna.umap <- ggplot(scrna.umap) + geom_point(aes(V1, V2)) + labs(title = paste("Scrna Umap on", i/100, "Overlap"), x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # plot Phate
  seurat.phate <- as.data.frame(obj@Seurat$Phate.Data)
p.seurat.phate <-  ggplot(seurat.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = paste("Seurat Phate on", i/100, "Overlap"), x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

  scrna.phate <- as.data.frame(obj@Scrna$Phate.Data)
p.scrna.phate <-  ggplot(scrna.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = paste("Scrna Phate on", i/100, "Overlap"), x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # combine the plots
  plots <- plot_grid(p.pca, p.pca.scrna, p.seurat.tsne, p.scrna.tsne, 
                         p.seurat.umap, p.scrna.umap, p.seurat.phate, p.scrna.phate, 
                     heatmap, labels = c("A", "B","C", "D", "E", "F","G", "H", "I"))
    

  
  plot_lists[[i]] <- plots
  gc()
  
  
}
```

## save plots
```{r}
pdf("Results/Pipeline/Paper_Plots/Cluster_Overlap_Simulations_Plots_Phate.pdf", width = 10, height = 10)
for(i in overlaps){
  plot(plot_lists[[i]])
}
dev.off()
```

## Path lengths
```{r}
overlaps <- seq(2, 12, 1)
plot_lists <- list()


# simulation parameters
prob_vec <- c(1/3, 1/3, 1/3)

for(i in overlaps){
  
  cat(paste("\nRunning on",i,"paths\n"))
  
  params.groups <- newSplatParams(batchCells = 2000, nGenes = 2000, seed = 1994)
  
  # run simulations
  sim <- splatSimulatePaths(params.groups, path.length = i, de.prob = 0.5, de.facLoc = 0.5, verbose = FALSE)
  
  # extract the counts
  sim_counts <- counts(sim)
  
  # run the pipeline
  obj <- CreateModalityObject(sim_counts)
  
  # add the seurat slot
  obj <- PreprocessObject(obj,  nFeatures = 500)
  
  # add the scrna slot
  obj <- PreprocessObject(obj, method = "Scrna", nFeatures = 500)
  
  # Run the Seurat modality tests
  obj <- TestModality(obj)
  obj <- TestModality(obj, type = "Scrna")

  # compute a result table for all the tests
  seurat <- as.data.frame(unlist(obj@Tests$Seurat))
  colnames(seurat) <- c("Seurat.Dip.Pvalue")
  
  scrna <- as.data.frame(unlist(obj@Tests$Scrna))
  colnames(scrna) <- c("Scrna.Dip.Pvalue")
  
  res.table <- cbind(scrna, seurat)
  colnames(res.table) <- c("Seurat", "Scrna")
  
  # plot heat map
  obj.heatmap <- pheatmap(as.matrix(res.table), cluster_rows = F, cluster_cols = F, breaks = c(0, 0.05, 1), color = c("lightblue", "gray"), main = paste("Heatmap"))
  heatmap <- as.ggplot(obj.heatmap)
  
  seurat_pca_df <- as.data.frame(obj@Seurat$Sig.PCs.Data[, 1:2])
  scrna_pca_df <- as.data.frame(obj@Scrna$Sig.PCs.Data[, 1:2])
  
  # Run PCA
  p.pca <- ggplot(seurat_pca_df) + geom_point(aes(PC_1, PC_2))  +
                                          xlab("PC1") + ylab("PC2") +  ggtitle(paste("Seurat PCA on path length", i)) + theme_grey() +
                                            theme(plot.title = element_text(hjust = 0.5))
  p.pca.scrna <- ggplot(scrna_pca_df) + geom_point(aes(PC1, PC2))  +
                                          xlab("PC1") + ylab("PC2") +  ggtitle(paste("Scrna PCA on path length", i)) + theme_grey() +
                                            theme(plot.title = element_text(hjust = 0.5))
  
  # Plot the Tsne
  seurat.tsne <- as.data.frame(obj@Seurat$Tsne.Data)
  p.seurat.tsne <-  ggplot(seurat.tsne) + geom_point(aes(V1, V2)) + labs(title = paste("Seurat Tsne on path length", i), x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  scrna.tsne <- as.data.frame(obj@Scrna$Tsne.Data)
  p.scrna.tsne <-  ggplot(scrna.tsne) + geom_point(aes(V1, V2)) + labs(title = paste("Scrna Tsne on path length", i), x = "Tsne_1", y = "Tsne_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # plot UMAP
  seurat.umap <- as.data.frame(obj@Seurat$Umap.Data)
  p.seurat.umap <- ggplot(seurat.umap) + geom_point(aes(V1, V2)) + labs(title = paste("Seurat Umap on path length", i), x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  scrna.umap <- as.data.frame(obj@Scrna$Umap.Data)
  p.scrna.umap <- ggplot(scrna.umap) + geom_point(aes(V1, V2)) + labs(title = paste("Scrna Umap on path length", i), x = "UMAP_1", y = "UMAP_1") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # plot Phate
  seurat.phate <- as.data.frame(obj@Seurat$Phate.Data)
p.seurat.phate <-  ggplot(seurat.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = paste("Seurat Phate on path length", i), x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))

  scrna.phate <- as.data.frame(obj@Scrna$Phate.Data)
p.scrna.phate <-  ggplot(scrna.phate) + geom_point(aes(PHATE1, PHATE2)) + labs(title = paste("Scrna Phate on path length", i), x = "Phate_1", y = "Phate_2") + theme_gray() + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
  
  # combine the plots
  plots <- plot_grid(p.pca, p.pca.scrna, p.seurat.tsne, p.scrna.tsne, 
                         p.seurat.umap, p.scrna.umap, p.seurat.phate, p.scrna.phate, 
                     heatmap, labels = c("A", "B","C", "D", "E", "F","G", "H", "I"))
    

  
  plot_lists[[i]] <- plots
  gc()
  
}
```

## save plots
```{r}
pdf("Results/Pipeline/Paper_Plots/Paths_Simulations_Plots_Phate.pdf", width = 10, height = 10)
for(i in overlaps){
  plot(plot_lists[[i]])
}
dev.off()
```